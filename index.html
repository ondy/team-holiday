<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Urlaubsplanung</title>
  <style>
    :root {
      --weekend: #d9f0ff;
      --holiday: #fff6cc;
      --grid-border: #d6d6d6;
      --status-urlaub: #7bd889;
      --status-urlaub-half: #b7f0c0;
      --status-krank: #ff9b9b;
      --status-schulung: #9fb7ff;
      --status-einsatz: #ffd18a;
      --status-gleittag: #9be7e7;
      --school-holiday: #e5e5e5;
      --hover-highlight: #4b4f55;
      --today-highlight: #1b1b1b;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 24px;
      color: #1f1f1f;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    h1 {
      margin-bottom: 16px;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .actions button {
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    .actions button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .tab-button {
      border: 1px solid #bfc9d4;
      background: #f3f5f7;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    .tab-button.active {
      background: #1d6fa5;
      color: white;
      border-color: #1d6fa5;
    }

    .tab-button.current-month {
      border-width: 2px;
      border-color: #000;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
      user-select: none;
    }

    th,
    td {
      border: 1px solid var(--grid-border);
      text-align: center;
      min-width: 10px;
      min-height: 10px;
      padding: 4px;
      font-size: 12px;
    }

    th.member-column,
    td.member-column {
      text-align: left;
      width: 180px;
      min-width: 180px;
      background: #fafafa;
      font-weight: 600;
    }

    td.member-input {
      font-weight: 400;
      cursor: text;
    }

    .member-input input {
      width: 95%;
      font-size: 12px;
      padding: 2px 4px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
    }

    .member-input .input-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .member-input .ok-button {
      border: none;
      background: #1d6fa5;
      color: white;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
    }

    .member-input input::placeholder {
      color: #9ca3af;
    }

    .cell {
      cursor: pointer;
      height: 22px;
    }

    .vacation-cell {
      position: relative;
    }

    .vacation-cell .approval-toggle {
      position: absolute;
      top: 2px;
      right: 2px;
      display: none;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      padding: 2px;
      z-index: 3;
    }

    .vacation-cell:hover .approval-toggle {
      display: block;
    }

    .vacation-approved::after {
      content: "✓";
      position: absolute;
      right: 4px;
      bottom: 2px;
      font-size: 12px;
      color: #1d6fa5;
      font-weight: 700;
    }

    .day-short {
      font-size: 10px;
      color: #555;
      line-height: 1.1;
    }

    .weekend {
      background: var(--weekend);
    }

    .holiday {
      background: var(--holiday);
    }

    .school-holiday {
      background: var(--school-holiday);
    }

    .context-menu {
      position: absolute;
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
      padding: 8px;
      display: none;
      z-index: 20;
      min-width: 180px;
    }

    .outside-month {
      opacity: 0.8;
    }

    .month-boundary-left {
      border-left: 3px solid #111827;
    }

    .month-boundary-right {
      border-right: 3px solid #111827;
    }

    .context-menu button {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 6px 8px;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      border-radius: 6px;
      font-size: 13px;
    }

    .context-menu button:hover {
      background: #f0f4f8;
    }

    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 4px;
      display: inline-block;
      border: 1px solid #a3a3a3;
    }

    .status-urlaub {
      background: var(--status-urlaub);
    }

    .status-urlaub-half {
      background: var(--status-urlaub-half);
    }

    .status-urlaub-am {
      background: linear-gradient(135deg, var(--status-urlaub-half) 0 50%, transparent 50% 100%);
    }

    .status-urlaub-pm {
      background: linear-gradient(135deg, transparent 0 50%, var(--status-urlaub-half) 50% 100%);
    }

    .status-krank {
      background: var(--status-krank);
    }

    .status-schulung {
      background: var(--status-schulung);
    }

    .status-einsatz {
      background: var(--status-einsatz);
    }

    .status-gleittag {
      background: var(--status-gleittag);
    }

    .legend {
      margin-top: 12px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      font-size: 12px;
      align-items: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .legend-divider {
      width: 1px;
      height: 20px;
      background: #c7c7c7;
    }

    .row-highlight td,
    .row-highlight th {
      background-color: rgba(0, 0, 0, 0.08);
    }

    .col-highlight {
      background-color: rgba(0, 0, 0, 0.08);
    }

    .today-column-highlight {
      position: absolute;
      top: 0;
      bottom: 0;
      border: 2px solid var(--today-highlight);
      pointer-events: none;
      z-index: 5;
    }

    .table-wrapper {
      position: relative;
    }

    .cell-selected {
      background-image: linear-gradient(rgba(29, 111, 165, 0.25), rgba(29, 111, 165, 0.25));
    }

    .mini-cell {
      font-size: 11px;
      color: #555;
    }

    .member-row .delete-button {
      margin-left: 8px;
      border: none;
      background: #ef4444;
      color: white;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 11px;
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
    }

    .member-row:hover .delete-button {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 id="page-title"></h1>
    <div class="actions">
      <button id="undo-button" type="button" title="Undo">↶ Undo</button>
      <button id="redo-button" type="button" title="Redo">↷ Redo</button>
    </div>
  </div>
  <div class="tabs" id="month-tabs"></div>
  <div id="calendar-container"></div>

  <div class="legend">
    <div class="legend-group">
      <div class="legend-item"><span class="color-dot weekend"></span> Wochenende</div>
      <div class="legend-item"><span class="color-dot holiday"></span> Feiertag</div>
      <div class="legend-item"><span class="color-dot school-holiday"></span> NRW Ferien</div>
    </div>
    <div class="legend-divider" aria-hidden="true"></div>
    <div class="legend-group">
      <div class="legend-item"><span class="color-dot status-urlaub"></span> Urlaub</div>
      <div class="legend-item"><span class="color-dot status-urlaub-am"></span> Urlaub vormittags</div>
      <div class="legend-item"><span class="color-dot status-urlaub-pm"></span> Urlaub nachmittags</div>
      <div class="legend-item"><span class="color-dot status-krank"></span> krank</div>
      <div class="legend-item"><span class="color-dot status-schulung"></span> Schulung</div>
      <div class="legend-item"><span class="color-dot status-einsatz"></span> Einsatz</div>
      <div class="legend-item"><span class="color-dot status-gleittag"></span> Gleittag</div>
    </div>
  </div>

  <div class="context-menu" id="context-menu"></div>

  <script>
    const statusOptions = [
      { label: "nichts", value: "", className: "" },
      { label: "Urlaub", value: "urlaub", className: "status-urlaub" },
      { label: "Urlaub vormittags", value: "urlaub-am", className: "status-urlaub-am" },
      { label: "Urlaub nachmittags", value: "urlaub-pm", className: "status-urlaub-pm" },
      { label: "krank", value: "krank", className: "status-krank" },
      { label: "Schulung", value: "schulung", className: "status-schulung" },
      { label: "Einsatz", value: "einsatz", className: "status-einsatz", requiresWeekendOrHoliday: true },
      { label: "Gleittag", value: "gleittag", className: "status-gleittag" },
    ];

    const monthNames = [
      "Januar",
      "Februar",
      "März",
      "April",
      "Mai",
      "Juni",
      "Juli",
      "August",
      "September",
      "Oktober",
      "November",
      "Dezember",
    ];

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonthIndex = now.getMonth();
    const currentDay = now.getDate();
    let activeMonth = 0;

    const storageKey = "teamHolidayData";

    const data = loadData();
    const schoolHolidayDates = new Set();
    const undoStack = [];
    const redoStack = [];
    let isSelecting = false;
    let lastSelectionEvent = null;
    let selectionStart = null;
    let selectionEnd = null;
    const selectedCells = new Map();
    let activeTable = null;
    let justOpenedMenu = false;

    function loadData() {
      try {
        const stored = JSON.parse(localStorage.getItem(storageKey)) || {
          members: [],
          years: {},
        };
        return normalizeData(stored);
      } catch (error) {
        return { members: [], years: {} };
      }
    }

    function normalizeData(stored) {
      const normalized = {
        members: Array.isArray(stored.members) ? stored.members : [],
        years: stored.years || {},
      };

      if (!normalized.members.length && stored.months) {
        const firstMonthWithMembers = Object.values(stored.months).find(
          (month) => month && Array.isArray(month.members) && month.members.length
        );
        if (firstMonthWithMembers) {
          normalized.members = firstMonthWithMembers.members.map((member) => ({
            name: member.name || "",
          }));
        }
      }

      if (stored.months && !normalized.years[currentYear]) {
        normalized.years[currentYear] = { months: stored.months };
      }

      Object.values(normalized.years).forEach((yearData) => {
        if (!yearData.months) {
          yearData.months = {};
        }
        Object.values(yearData.months).forEach((month) => {
          if (month && month.members) {
            delete month.members;
          }
          if (month && !month.days) {
            month.days = {};
          }
          if (month && !month.approved) {
            month.approved = {};
          }
          if (month && month.days) {
            migrateHalfDayStatuses(month.days);
          }
        });
      });

      sortMembersAndReindex(normalized);
      return normalized;
    }

    function saveData() {
      localStorage.setItem(storageKey, JSON.stringify(data));
    }

    function snapshotData() {
      return JSON.stringify(data);
    }

    function recordUndoState() {
      undoStack.push(snapshotData());
      redoStack.length = 0;
      updateUndoRedoButtons();
    }

    function applySnapshot(snapshot) {
      const parsed = JSON.parse(snapshot);
      data.members = parsed.members || [];
      data.years = parsed.years || {};
    }

    function updateUndoRedoButtons() {
      const undoButton = document.getElementById("undo-button");
      const redoButton = document.getElementById("redo-button");
      undoButton.disabled = undoStack.length === 0;
      redoButton.disabled = redoStack.length === 0;
    }

    function handleUndo() {
      if (!undoStack.length) {
        return;
      }
      redoStack.push(snapshotData());
      const snapshot = undoStack.pop();
      applySnapshot(snapshot);
      saveData();
      renderCalendar();
      updateUndoRedoButtons();
    }

    function handleRedo() {
      if (!redoStack.length) {
        return;
      }
      undoStack.push(snapshotData());
      const snapshot = redoStack.pop();
      applySnapshot(snapshot);
      saveData();
      renderCalendar();
      updateUndoRedoButtons();
    }

    function getSchoolHolidayStorageKey(year) {
      return `schoolHolidaysNW_${year}`;
    }

    function loadSchoolHolidays(year) {
      const cached = localStorage.getItem(getSchoolHolidayStorageKey(year));
      if (cached) {
        try {
          const parsed = JSON.parse(cached);
          applySchoolHolidays(parsed);
          return Promise.resolve();
        } catch (error) {
          localStorage.removeItem(getSchoolHolidayStorageKey(year));
        }
      }

      return fetch(`https://ferien-api.de/api/v1/holidays/NW/${year}`)
        .then((response) => response.json())
        .then((entries) => {
          localStorage.setItem(getSchoolHolidayStorageKey(year), JSON.stringify(entries));
          applySchoolHolidays(entries);
        })
        .catch(() => {});
    }

    function applySchoolHolidays(entries) {
      schoolHolidayDates.clear();
      if (!Array.isArray(entries)) {
        return;
      }
      entries.forEach((entry) => {
        const start = new Date(entry.start);
        const end = new Date(entry.end);
        for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
          const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
          schoolHolidayDates.add(key);
        }
      });
    }

    function getMonthData(year, monthIndex) {
      if (!data.years[year]) {
        data.years[year] = { months: {} };
      }
      const yearData = data.years[year];
      if (!yearData.months[monthIndex]) {
        yearData.months[monthIndex] = { days: {}, approved: {} };
      } else if (!yearData.months[monthIndex].days) {
        yearData.months[monthIndex].days = {};
      }
      if (!yearData.months[monthIndex].approved) {
        yearData.months[monthIndex].approved = {};
      }
      return yearData.months[monthIndex];
    }

    function getDaysInMonth(year, monthIndex) {
      return new Date(year, monthIndex + 1, 0).getDate();
    }

    function getHolidays(year) {
      const fixed = [
        { month: 0, day: 1, name: "Neujahr" },
        { month: 4, day: 1, name: "Tag der Arbeit" },
        { month: 9, day: 3, name: "Tag der Deutschen Einheit" },
        { month: 10, day: 1, name: "Allerheiligen" },
        { month: 11, day: 25, name: "1. Weihnachtstag" },
        { month: 11, day: 26, name: "2. Weihnachtstag" },
      ];

      const easter = getEasterSunday(year);
      const movable = [
        { date: offsetDate(easter, 0), name: "Ostersonntag" },
        { date: offsetDate(easter, 1), name: "Ostermontag" },
        { date: offsetDate(easter, 39), name: "Christi Himmelfahrt" },
        { date: offsetDate(easter, 49), name: "Pfingstsonntag" },
        { date: offsetDate(easter, 50), name: "Pfingstmontag" },
        { date: offsetDate(easter, 60), name: "Fronleichnam" },
      ];

      return fixed
        .map((date) => ({
          date: new Date(year, date.month, date.day),
          name: date.name,
        }))
        .concat(movable);
    }

    function getEasterSunday(year) {
      const a = year % 19;
      const b = Math.floor(year / 100);
      const c = year % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const l = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * l) / 451);
      const month = Math.floor((h + l - 7 * m + 114) / 31);
      const day = ((h + l - 7 * m + 114) % 31) + 1;
      return new Date(year, month - 1, day);
    }

    function offsetDate(date, days) {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    }

    const holidaySet = new Set();
    const holidayNameMap = new Map();
    [currentYear - 1, currentYear, currentYear + 1].forEach((year) => {
      getHolidays(year).forEach((holiday) => {
        const key = `${holiday.date.getFullYear()}-${String(holiday.date.getMonth() + 1).padStart(2, "0")}-${String(holiday.date.getDate()).padStart(2, "0")}`;
        holidaySet.add(key);
        holidayNameMap.set(key, holiday.name);
      });
    });

    function buildTabs() {
      const container = document.getElementById("month-tabs");
      container.innerHTML = "";
      monthNames.forEach((name, index) => {
        const button = document.createElement("button");
        const isActive = index === activeMonth;
        const isCurrentMonth = index === currentMonthIndex;
        button.className = "tab-button" + (isActive ? " active" : "") + (isCurrentMonth ? " current-month" : "");
        button.textContent = name;
        button.addEventListener("click", () => {
          activeMonth = index;
          renderCalendar();
        });
        container.appendChild(button);
      });
    }

    function renderCalendar() {
      buildTabs();
      const title = document.getElementById("page-title");
      title.textContent = `${monthNames[activeMonth]} ${currentYear}`;
      const container = document.getElementById("calendar-container");
      container.innerHTML = "";

      const monthData = getMonthData(currentYear, activeMonth);
      const daysInMonth = getDaysInMonth(currentYear, activeMonth);
      const dayColumns = buildDayColumns(currentYear, activeMonth);

      const wrapper = document.createElement("div");
      wrapper.className = "table-wrapper";
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");

      const memberHeader = document.createElement("th");
      memberHeader.className = "member-column";
      memberHeader.textContent = "";
      memberHeader.dataset.col = "member";
      headerRow.appendChild(memberHeader);

      dayColumns.forEach((dayInfo) => {
        const th = document.createElement("th");
      const baseLabel = `${String(dayInfo.day).padStart(2, "0")}.${String(dayInfo.month).padStart(2, "0")}`;
      const dayLabel = baseLabel;
        const weekday = dayInfo.date.toLocaleDateString("de-DE", { weekday: "short" });
        th.innerHTML = `${dayLabel}<div class="day-short">${weekday}</div>`;
        th.dataset.col = dayInfo.colKey;
        if (dayInfo.inMonth) {
          th.dataset.day = String(dayInfo.day);
        }
        if (!dayInfo.inMonth) {
          th.classList.add("outside-month");
        }
        const holidayName = holidayNameMap.get(dayInfo.key);
        if (holidayName) {
          th.title = holidayName;
        }
        if (dayInfo.position === "start") {
          th.classList.add("month-boundary-left");
        }
        if (dayInfo.position === "end") {
          th.classList.add("month-boundary-right");
        }
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      const rows = [...data.members];
      rows.push({ name: "" });

      rows.forEach((member, index) => {
        const tr = document.createElement("tr");
        tr.className = "member-row";

        const nameCell = document.createElement("td");
        nameCell.className = "member-column member-input";
        nameCell.dataset.col = "member";
        const nameSpan = document.createElement("span");
        nameSpan.className = "member-name";
        nameSpan.textContent = member.name || "";
        nameCell.appendChild(nameSpan);
        nameCell.addEventListener("click", () => editMemberName(nameCell, index));
        if (index < data.members.length) {
          const deleteButton = document.createElement("button");
          deleteButton.type = "button";
          deleteButton.className = "delete-button";
          deleteButton.textContent = "Löschen";
          deleteButton.addEventListener("click", (event) => {
            event.stopPropagation();
            removeMember(index);
          });
          nameCell.appendChild(deleteButton);
        } else {
          createMemberInput(nameCell, index, "");
        }
        tr.appendChild(nameCell);

        dayColumns.forEach((dayInfo) => {
          const td = document.createElement("td");
          td.className = "cell";
          td.dataset.col = dayInfo.colKey;
          if (!dayInfo.inMonth) {
            td.classList.add("outside-month");
          }
          if (dayInfo.position === "start") {
            td.classList.add("month-boundary-left");
          }
          if (dayInfo.position === "end") {
            td.classList.add("month-boundary-right");
          }
          const dateKey = dayInfo.key;
          const isWeekend = [0, 6].includes(dayInfo.date.getDay());
          const isHoliday = holidaySet.has(dateKey);

          const targetMonthData = getMonthData(dayInfo.year, dayInfo.monthIndex);
          const status = targetMonthData.days?.[index]?.[dayInfo.day];
          if (status) {
            td.classList.add(`status-${status}`);
          } else if (isHoliday) {
            td.classList.add("holiday");
          } else if (isWeekend) {
            td.classList.add("weekend");
          } else if (schoolHolidayDates.has(dateKey)) {
            td.classList.add("school-holiday");
          }

          if (status && isVacationStatus(status)) {
            td.classList.add("vacation-cell");
            if (targetMonthData.approved?.[index]?.[dayInfo.day]) {
              td.classList.add("vacation-approved");
            }
            if (dayInfo.inMonth) {
              const approvalToggle = document.createElement("label");
              approvalToggle.className = "approval-toggle";
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.checked = Boolean(targetMonthData.approved?.[index]?.[dayInfo.day]);
              checkbox.addEventListener("mousedown", (event) => {
                event.stopPropagation();
              });
              checkbox.addEventListener("click", (event) => {
                event.stopPropagation();
                toggleVacationApproval(index, dayInfo.day);
              });
              approvalToggle.appendChild(checkbox);
              td.appendChild(approvalToggle);
            }
          }

          if (dayInfo.inMonth) {
            td.dataset.memberIndex = index;
            td.dataset.day = dayInfo.day;
            td.addEventListener("mousedown", (event) => handleCellMouseDown(event, td));
            td.addEventListener("mouseover", () => handleCellMouseOver(td));
          }
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);

      const tfoot = document.createElement("tfoot");
      const summaryRow = document.createElement("tr");
      const summaryLabel = document.createElement("td");
      summaryLabel.className = "member-column mini-cell";
      summaryLabel.textContent = "";
      summaryRow.appendChild(summaryLabel);
      dayColumns.forEach((dayInfo) => {
        const summaryCell = document.createElement("td");
        summaryCell.className = "mini-cell";
        if (dayInfo.inMonth) {
          const count = data.members.reduce((total, _member, memberIndex) => {
            const value = monthData.days?.[memberIndex]?.[dayInfo.day];
            return value ? total + 1 : total;
          }, 0);
          summaryCell.textContent = count ? String(count) : "";
        } else {
          summaryCell.textContent = "";
        }
        summaryRow.appendChild(summaryCell);
      });
      tfoot.appendChild(summaryRow);
      table.appendChild(tfoot);

      wrapper.appendChild(table);
      container.appendChild(wrapper);
      addTableHoverHighlights(table);
      activeTable = table;
      clearSelection();
      renderTodayColumnHighlight(wrapper, table, daysInMonth);
    }

    function buildDayColumns(year, monthIndex) {
      const daysInMonth = getDaysInMonth(year, monthIndex);
      const prevMonthDate = new Date(year, monthIndex, 0);
      const prevDay = prevMonthDate.getDate();
      const nextMonthDate = new Date(year, monthIndex + 1, 1);
      const columns = [];

      const addColumn = (date, inMonth, day, position = "") => {
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
        columns.push({
          date,
          key,
          inMonth,
          day,
          month: date.getMonth() + 1,
          monthIndex: date.getMonth(),
          year: date.getFullYear(),
          colKey: `col-${columns.length}`,
          position,
        });
      };

      addColumn(new Date(year, monthIndex - 1, prevDay), false, prevDay, "before");
      for (let day = 1; day <= daysInMonth; day += 1) {
        const position = day === 1 ? "start" : day === daysInMonth ? "end" : "";
        addColumn(new Date(year, monthIndex, day), true, day, position);
      }
      addColumn(new Date(year, monthIndex + 1, 1), false, 1, "after");

      return columns;
    }

    function renderTodayColumnHighlight(wrapper, table, daysInMonth) {
      if (activeMonth !== currentMonthIndex || currentDay > daysInMonth) {
        return;
      }
      const headerCell = table.querySelector(`th[data-day="${currentDay}"]`);
      if (!headerCell) {
        return;
      }
      const highlight = document.createElement("div");
      highlight.className = "today-column-highlight";
      wrapper.appendChild(highlight);
      window.requestAnimationFrame(() => {
        const wrapperRect = wrapper.getBoundingClientRect();
        const cellRect = headerCell.getBoundingClientRect();
        const left = cellRect.left - wrapperRect.left;
        highlight.style.left = `${left}px`;
        highlight.style.width = `${cellRect.width}px`;
      });
    }

    function finalizeMemberInput(cell, index, input) {
      const name = input.value.trim();
      const isExisting = index < data.members.length;
      const previousName = isExisting ? data.members[index].name : "";
      if (!name && !isExisting) {
        renderCalendar();
        return;
      }
      if (isExisting && name === previousName) {
        renderCalendar();
        return;
      }
      recordUndoState();
      if (isExisting) {
        data.members[index].name = name;
      } else {
        data.members.push({ name });
      }

      sortMembersAndReindex(data);
      saveData();
      renderCalendar();
    }

    function createMemberInput(cell, index, initialValue = "") {
      const wrapper = document.createElement("div");
      wrapper.className = "input-wrapper";
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Name eingeben";
      input.value = initialValue;
      const okButton = document.createElement("button");
      okButton.type = "button";
      okButton.className = "ok-button";
      okButton.textContent = "OK";
      okButton.addEventListener("click", (event) => {
        event.stopPropagation();
        finalizeMemberInput(cell, index, input);
      });
      wrapper.appendChild(input);
      wrapper.appendChild(okButton);
      cell.textContent = "";
      cell.appendChild(wrapper);
      input.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          finalizeMemberInput(cell, index, input);
        }
      });
      input.addEventListener("blur", () => {
        if (index === data.members.length && !input.value.trim()) {
          cell.textContent = "";
          createMemberInput(cell, index, "");
        }
      });
      return input;
    }

    function editMemberName(cell, index) {
      if (cell.querySelector("input")) {
        return;
      }
      const existingValue = cell.querySelector(".member-name")?.textContent || "";
      const input = createMemberInput(cell, index, existingValue);
      input.focus();
      input.select();
    }

    function removeMember(index) {
      const member = data.members[index];
      if (!member) {
        return;
      }
      if (!window.confirm(`Möchtest du ${member.name || "dieses Team-Mitglied"} wirklich löschen?`)) {
        return;
      }
      recordUndoState();
      data.members.splice(index, 1);
      Object.values(data.years).forEach((yearData) => {
        if (!yearData.months) {
          return;
        }
        Object.values(yearData.months).forEach((month) => {
          if (!month || !month.days) {
            return;
          }
          const reordered = {};
          Object.entries(month.days).forEach(([memberIndex, days]) => {
            const numericIndex = Number(memberIndex);
            if (numericIndex < index) {
              reordered[numericIndex] = days;
            } else if (numericIndex > index) {
              reordered[numericIndex - 1] = days;
            }
          });
          month.days = reordered;
          if (month.approved) {
            const reorderedApproved = {};
            Object.entries(month.approved).forEach(([memberIndex, days]) => {
              const numericIndex = Number(memberIndex);
              if (numericIndex < index) {
                reorderedApproved[numericIndex] = days;
              } else if (numericIndex > index) {
                reorderedApproved[numericIndex - 1] = days;
              }
            });
            month.approved = reorderedApproved;
          }
        });
      });
      saveData();
      renderCalendar();
    }

    function openContextMenu(event, selection) {
      if (!selection.length) {
        return;
      }
      const monthData = getMonthData(currentYear, activeMonth);

      const menu = document.getElementById("context-menu");
      menu.innerHTML = "";

      statusOptions.forEach((option) => {
        if (option.requiresWeekendOrHoliday && !selection.every(({ day }) => isWeekendOrHoliday(day))) {
          return;
        }
        const button = document.createElement("button");
        const color = document.createElement("span");
        color.className = `color-dot ${option.className}`.trim();
        button.appendChild(color);
        button.append(option.label);
        button.addEventListener("click", () => {
          recordUndoState();
          selection.forEach(({ memberIndex, day }) => {
            if (!monthData.days[memberIndex]) {
              monthData.days[memberIndex] = {};
            }
            if (option.value) {
              monthData.days[memberIndex][day] = option.value;
            } else {
              delete monthData.days[memberIndex][day];
            }
          });
          saveData();
          menu.style.display = "none";
          renderCalendar();
        });
        menu.appendChild(button);
      });

      menu.style.top = `${event.pageY + 6}px`;
      menu.style.left = `${event.pageX + 6}px`;
      menu.style.display = "block";
      constrainMenuToViewport(menu);
      justOpenedMenu = true;
      window.setTimeout(() => {
        justOpenedMenu = false;
      }, 0);
    }

    function isWeekendOrHoliday(day) {
      const dateKey = `${currentYear}-${String(activeMonth + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
      const isWeekend = [0, 6].includes(new Date(currentYear, activeMonth, day).getDay());
      const isHoliday = holidaySet.has(dateKey);
      return isWeekend || isHoliday;
    }

    function isVacationStatus(status) {
      return ["urlaub", "urlaub-am", "urlaub-pm"].includes(status);
    }

    function constrainMenuToViewport(menu) {
      const rect = menu.getBoundingClientRect();
      let left = rect.left;
      let top = rect.top;
      const padding = 8;
      if (rect.right > window.innerWidth - padding) {
        left = window.innerWidth - rect.width - padding;
      }
      if (rect.bottom > window.innerHeight - padding) {
        top = window.innerHeight - rect.height - padding;
      }
      if (left < padding) {
        left = padding;
      }
      if (top < padding) {
        top = padding;
      }
      menu.style.left = `${left + window.scrollX}px`;
      menu.style.top = `${top + window.scrollY}px`;
    }

    function getVacationBlock(memberIndex, day, monthData) {
      let start = day;
      let end = day;
      while (start > 1 && isVacationStatus(monthData.days?.[memberIndex]?.[start - 1])) {
        start -= 1;
      }
      while (
        end < getDaysInMonth(currentYear, activeMonth) &&
        isVacationStatus(monthData.days?.[memberIndex]?.[end + 1])
      ) {
        end += 1;
      }
      return { start, end };
    }

    function toggleVacationApproval(memberIndex, day) {
      const monthData = getMonthData(currentYear, activeMonth);
      if (!isVacationStatus(monthData.days?.[memberIndex]?.[day])) {
        return;
      }
      recordUndoState();
      if (!monthData.approved[memberIndex]) {
        monthData.approved[memberIndex] = {};
      }
      const { start, end } = getVacationBlock(memberIndex, day, monthData);
      const shouldApprove = !monthData.approved[memberIndex][day];
      for (let currentDay = start; currentDay <= end; currentDay += 1) {
        if (shouldApprove) {
          monthData.approved[memberIndex][currentDay] = true;
        } else {
          delete monthData.approved[memberIndex][currentDay];
        }
      }
      if (Object.keys(monthData.approved[memberIndex]).length === 0) {
        delete monthData.approved[memberIndex];
      }
      saveData();
      renderCalendar();
    }

    function handleCellMouseDown(event, cell) {
      if (event.button !== 0) {
        return;
      }
      event.preventDefault();
      clearSelection();
      isSelecting = true;
      lastSelectionEvent = event;
      selectionStart = getCellInfo(cell);
      selectionEnd = selectionStart;
      updateSelectionRectangle();
    }

    function handleCellMouseOver(cell) {
      if (!isSelecting) {
        return;
      }
      selectionEnd = getCellInfo(cell);
      updateSelectionRectangle();
    }

    function updateSelectionRectangle() {
      if (!selectionStart || !selectionEnd || !activeTable) {
        return;
      }
      clearSelectionCells();
      const minMember = Math.min(selectionStart.memberIndex, selectionEnd.memberIndex);
      const maxMember = Math.max(selectionStart.memberIndex, selectionEnd.memberIndex);
      const minDay = Math.min(selectionStart.day, selectionEnd.day);
      const maxDay = Math.max(selectionStart.day, selectionEnd.day);

      for (let memberIndex = minMember; memberIndex <= maxMember; memberIndex += 1) {
        for (let day = minDay; day <= maxDay; day += 1) {
          const cell = activeTable.querySelector(
            `td.cell[data-member-index="${memberIndex}"][data-day="${day}"]`
          );
          if (cell) {
            const info = getCellInfo(cell);
            if (!info || selectedCells.has(info.key)) {
              continue;
            }
            selectedCells.set(info.key, info);
            cell.classList.add("cell-selected");
          }
        }
      }
    }

    function clearSelectionCells() {
      selectedCells.forEach((info) => {
        info.cell.classList.remove("cell-selected");
      });
      selectedCells.clear();
    }

    function clearSelection() {
      clearSelectionCells();
      isSelecting = false;
      selectionStart = null;
      selectionEnd = null;
    }

    function getCellInfo(cell) {
      const memberIndex = Number(cell.dataset.memberIndex);
      const day = Number(cell.dataset.day);
      if (!Number.isFinite(memberIndex) || !Number.isFinite(day)) {
        return null;
      }
      if (!data.members[memberIndex]) {
        return null;
      }
      return {
        memberIndex,
        day,
        key: `${memberIndex}-${day}`,
        cell,
      };
    }

    function handleSelectionComplete(event) {
      if (!isSelecting) {
        return;
      }
      isSelecting = false;
      lastSelectionEvent = event;
      const selection = Array.from(selectedCells.values()).map(({ memberIndex, day }) => ({ memberIndex, day }));
      if (selection.length) {
        openContextMenu(lastSelectionEvent, selection);
      }
    }

    window.addEventListener("mouseup", handleSelectionComplete);

    function sortMembersAndReindex(targetData) {
      const membersWithIndex = targetData.members.map((member, index) => ({
        ...member,
        originalIndex: index,
      }));
      const collator = new Intl.Collator("de", { sensitivity: "base" });
      membersWithIndex.sort((a, b) => {
        const nameA = (a.name || "").trim();
        const nameB = (b.name || "").trim();
        if (!nameA && !nameB) {
          return a.originalIndex - b.originalIndex;
        }
        if (!nameA) {
          return 1;
        }
        if (!nameB) {
          return -1;
        }
        const result = collator.compare(nameA, nameB);
        return result !== 0 ? result : a.originalIndex - b.originalIndex;
      });

      const indexMap = new Map();
      membersWithIndex.forEach((member, newIndex) => {
        indexMap.set(member.originalIndex, newIndex);
      });

      targetData.members = membersWithIndex.map(({ name }) => ({ name }));

      Object.values(targetData.years || {}).forEach((yearData) => {
        if (!yearData.months) {
          return;
        }
        Object.values(yearData.months).forEach((month) => {
          if (!month || !month.days) {
            return;
          }
          const reordered = {};
          Object.entries(month.days).forEach(([memberIndex, days]) => {
            const newIndex = indexMap.get(Number(memberIndex));
            if (newIndex !== undefined) {
              reordered[newIndex] = days;
            }
          });
          month.days = reordered;
          if (month.approved) {
            const reorderedApproved = {};
            Object.entries(month.approved).forEach(([memberIndex, days]) => {
              const newIndex = indexMap.get(Number(memberIndex));
              if (newIndex !== undefined) {
                reorderedApproved[newIndex] = days;
              }
            });
            month.approved = reorderedApproved;
          }
        });
      });
    }

    function migrateHalfDayStatuses(daysByMember) {
      Object.values(daysByMember).forEach((days) => {
        if (!days) {
          return;
        }
        Object.entries(days).forEach(([day, value]) => {
          if (value === "urlaub-half") {
            days[day] = "urlaub-am";
          }
        });
      });
    }

    function addTableHoverHighlights(table) {
      const clearHighlights = () => {
        table.querySelectorAll(".row-highlight").forEach((row) => row.classList.remove("row-highlight"));
        table.querySelectorAll(".col-highlight").forEach((cell) => cell.classList.remove("col-highlight"));
      };

      table.addEventListener("mouseover", (event) => {
        const cell = event.target.closest("td, th");
        if (!cell) {
          return;
        }
        clearHighlights();
        const row = cell.parentElement;
        if (row) {
          row.classList.add("row-highlight");
        }
        const colKey = cell.dataset.col;
        if (!colKey) {
          return;
        }
        table.querySelectorAll(`[data-col="${colKey}"]`).forEach((colCell) => {
          colCell.classList.add("col-highlight");
        });
      });

      table.addEventListener("mouseleave", () => {
        clearHighlights();
      });
    }

    document.addEventListener("click", (event) => {
      const menu = document.getElementById("context-menu");
      if (justOpenedMenu) {
        return;
      }
      if (!menu.contains(event.target) && !event.target.classList.contains("cell")) {
        menu.style.display = "none";
        clearSelection();
      }
    });

    renderCalendar();
    loadSchoolHolidays(currentYear).then(() => {
      renderCalendar();
    });

    const undoButton = document.getElementById("undo-button");
    const redoButton = document.getElementById("redo-button");
    undoButton.addEventListener("click", handleUndo);
    redoButton.addEventListener("click", handleRedo);
    updateUndoRedoButtons();
  </script>
</body>
</html>
